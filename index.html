<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Mobexpert - Recuperare Clien»õi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tooltip {
            position: relative;
            cursor: help;
        }
        .tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            white-space: nowrap;
            max-width: 300px;
            white-space: normal;
            transition: opacity 0.3s;
        }
        .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        .score-bar {
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
            height: 8px;
            border-radius: 4px;
            position: relative;
        }
        .score-indicator {
            position: absolute;
            top: -2px;
            width: 3px;
            height: 12px;
            background: #1f2937;
            border-radius: 1px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-blue-900 text-white p-4 mb-6">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">üè¢ CRM Mobexpert</h1>
            <div class="space-x-4">
                <button class="bg-blue-700 px-4 py-2 rounded hover:bg-blue-600 transition">Dashboard</button>
                <button class="px-4 py-2 rounded hover:bg-blue-700 transition">Clien»õi Activi</button>
                <button class="px-4 py-2 rounded hover:bg-blue-700 transition">Campanii</button>
                <button class="px-4 py-2 rounded hover:bg-blue-700 transition">Rapoarte</button>
            </div>
        </div>
    </nav>

    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä AnalizƒÉ Clien»õi Pierdu»õi</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        üõí √éncarcƒÉ Fi»ôier V√¢nzƒÉri (Excel/CSV)
                    </label>
                    <input type="file" id="salesFile" accept=".xlsx,.xls,.csv" 
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <p class="text-xs text-gray-500 mt-2">Coloane: MAGAZIN, ID CLIENT, CLIENT, DATA, VALOARE FACTURATA, CANTITATE FACTURATA, NR FACTURI</p>
                </div>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ‚ö†Ô∏è √éncarcƒÉ Fi»ôier Reclama»õii (Excel/CSV)
                    </label>
                    <input type="file" id="complaintsFile" accept=".xlsx,.xls,.csv"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                    <p class="text-xs text-gray-500 mt-2">Coloane: MAGAZIN, NR RECLAMATIE, DATA RECLAMATIE, MOTIV RECLAMATIE, ID CLIENT, DESCRIERE, RESPONSABIL COMANDA, Cantitate Reclamata</p>
                </div>
            </div>
            <div class="flex space-x-4">
                <button onclick="processData()" 
                        class="w-full md:w-auto bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                    üîç AnalizeazƒÉ Clien»õi Pierdu»õi
                </button>
                <button onclick="exportData()" 
                        class="w-full md:w-auto bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200" style="display: none;" id="exportButton">
                    üì§ ExportƒÉ Rezultate
                </button>
            </div>
        </div>

        <!-- Statistics -->
        <div id="stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" style="display: none;">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-2xl font-bold text-red-600" id="lostCount">0</div>
                <div class="text-sm text-gray-600">Clien»õi Pierdu»õi</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-2xl font-bold text-orange-600" id="complaintCount">0</div>
                <div class="text-sm text-gray-600">Cu Reclama»õii</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-2xl font-bold text-blue-600" id="lostRevenue">0 RON</div>
                <div class="text-sm text-gray-600">Valoare PierdutƒÉ</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-2xl font-bold text-green-600" id="voucherBudget">0 RON</div>
                <div class="text-sm text-gray-600">Buget Voucher-uri</div>
            </div>
        </div>

        <!-- Results Table -->
        <div id="results" class="bg-white rounded-lg shadow-md overflow-hidden" style="display: none;">
            <div class="px-6 py-4 bg-gray-50 border-b">
                <h2 class="text-xl font-semibold text-gray-800">üéØ Clien»õi de Recuperat (Ordona»õi dupƒÉ Prioritate)</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ultima ComandƒÉ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valoare TotalƒÉ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reclama»õii</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scoring</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Voucher</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div id="loadingMore" class="text-center py-4" style="display: none;">
                <div class="loader mx-auto mb-4"></div>
                <p class="text-gray-600">Se √ÆncarcƒÉ mai mul»õi clien»õi...</p>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-8" style="display: none;">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-600">Se proceseazƒÉ datele...</p>
        </div>
    </div>

    <script>
        let salesData = [];
        let complaintsData = [];
        let lostClients = [];
        let displayedClients = 0;
        const itemsPerLoad = 50;
        let isLoading = false;

        document.addEventListener('DOMContentLoaded', () => {
            const salesFileInput = document.getElementById('salesFile');
            const complaintsFileInput = document.getElementById('complaintsFile');
            
            if (salesFileInput) {
                salesFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) readExcelFile(file, 'sales');
                });
            }
            
            if (complaintsFileInput) {
                complaintsFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) readExcelFile(file, 'complaints');
                });
            }
        });

        function readExcelFile(file, type) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (type === 'sales') {
                    salesData = jsonData;
                    console.log('V√¢nzƒÉri √ÆncƒÉrcate:', salesData.length, '√ÆnregistrƒÉri');
                } else {
                    complaintsData = jsonData;
                    console.log('Reclama»õii √ÆncƒÉrcate:', complaintsData.length, '√ÆnregistrƒÉri');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processData() {
            if (salesData.length === 0 || complaintsData.length === 0) {
                alert('Te rog √ÆncarcƒÉ ambele fi»ôiere √Ænainte de analizƒÉ!');
                return;
            }

            const loadingElement = document.getElementById('loading');
            const resultsElement = document.getElementById('results');
            const statsElement = document.getElementById('stats');
            const exportButton = document.getElementById('exportButton');
            
            if (loadingElement) loadingElement.style.display = 'block';
            if (resultsElement) resultsElement.style.display = 'none';
            if (statsElement) statsElement.style.display = 'none';
            
            setTimeout(() => {
                analyzeClients();
                if (loadingElement) loadingElement.style.display = 'none';
                if (resultsElement) resultsElement.style.display = 'block';
                if (statsElement) statsElement.style.display = 'grid';
                if (exportButton) exportButton.style.display = 'block';
                displayedClients = 0;
                const tableBody = document.getElementById('tableBody');
                if (tableBody) tableBody.innerHTML = '';
                loadMoreClients();
            }, 500);
        }

        function analyzeClients() {
            // Procesare v√¢nzƒÉri cu noua structurƒÉ
            const clientSales = {};
            
            salesData.forEach(sale => {
                const clientId = sale['ID CLIENT'];
                if (!clientId) return;
                
                if (!clientSales[clientId]) {
                    clientSales[clientId] = {
                        id: clientId,
                        name: sale['CLIENT'] || 'Necunoscut',
                        magazine: sale['MAGAZIN'] || '',
                        sales: [],
                        totalValue: 0,
                        totalOrders: 0,
                        firstPurchase: null,
                        lastPurchase: null,
                        activeYears: 0
                    };
                }
                
                const value = parseFloat(sale['VALOARE FACTURATA'] || 0);
                const dateStr = sale['DATA'];
                let purchaseDate = null;
                
                if (dateStr) {
                    // Parse data √Æn format DD.MM.YYYY
                    const parts = dateStr.split('.');
                    if (parts.length === 3) {
                        purchaseDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                }
                
                if (!isNaN(value) && value > 0) {
                    clientSales[clientId].sales.push({
                        date: purchaseDate,
                        value: value,
                        quantity: parseFloat(sale['CANTITATE FACTURATA'] || 0)
                    });
                    clientSales[clientId].totalValue += value;
                    clientSales[clientId].totalOrders += parseInt(sale['NR FACTURI'] || 1);
                    
                    if (!clientSales[clientId].firstPurchase || (purchaseDate && purchaseDate < clientSales[clientId].firstPurchase)) {
                        clientSales[clientId].firstPurchase = purchaseDate;
                    }
                    if (!clientSales[clientId].lastPurchase || (purchaseDate && purchaseDate > clientSales[clientId].lastPurchase)) {
                        clientSales[clientId].lastPurchase = purchaseDate;
                    }
                }
            });

            // Calculare vechime »ôi frecven»õƒÉ
            Object.values(clientSales).forEach(client => {
                if (client.firstPurchase && client.lastPurchase) {
                    const years = (client.lastPurchase - client.firstPurchase) / (1000 * 60 * 60 * 24 * 365);
                    client.activeYears = Math.max(1, years);
                    client.ordersPerYear = client.totalOrders / client.activeYears;
                } else {
                    client.activeYears = 1;
                    client.ordersPerYear = client.totalOrders;
                }
            });

            // Procesare reclama»õii cu noua structurƒÉ
            const clientComplaints = {};
            
            complaintsData.forEach(complaint => {
                const clientId = complaint['ID CLIENT'];
                if (!clientId) return;
                
                if (!clientComplaints[clientId]) {
                    clientComplaints[clientId] = [];
                }
                
                const dateStr = complaint['DATA RECLAMATIE'];
                let complaintDate = null;
                
                if (dateStr) {
                    const parts = dateStr.split('.');
                    if (parts.length === 3) {
                        complaintDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                }
                
                clientComplaints[clientId].push({
                    date: complaintDate,
                    reason: complaint['MOTIV RECLAMATIE'] || '',
                    description: complaint['DESCRIERE'] || '',
                    responsible: complaint['RESPONSABIL COMANDA'] || '',
                    number: complaint['NR RECLAMATIE'] || '',
                    quantity: parseFloat(complaint['Cantitate Reclamata'] || 0)
                });
            });

            // Identificare clien»õi pierdu»õi cu scoring
            lostClients = [];
            const currentDate = new Date();
            
            Object.keys(clientSales).forEach(clientId => {
                const client = clientSales[clientId];
                const complaints = clientComplaints[clientId] || [];
                
                // Calculare timp de la ultima comandƒÉ
                let daysSinceLastPurchase = Infinity;
                if (client.lastPurchase) {
                    daysSinceLastPurchase = (currentDate - client.lastPurchase) / (1000 * 60 * 60 * 24);
                }
                
                // ConsiderƒÉm pierdu»õi dacƒÉ:
                // - Au reclama»õii »ôi nu au cumpƒÉrat √Æn ultimele 365 zile
                // - Sau nu au cumpƒÉrat √Æn ultimele 730 zile (2 ani)
                const isLost = (complaints.length > 0 && daysSinceLastPurchase > 365) || 
                              daysSinceLastPurchase > 730;
                
                if (isLost) {
                    const score = calculateClientScore(client, complaints);
                    const voucherAmount = Math.round((score / 100) * 1500);
                    
                    lostClients.push({
                        ...client,
                        complaints: complaints,
                        daysSinceLastPurchase: Math.round(daysSinceLastPurchase),
                        score: score,
                        voucherAmount: voucherAmount,
                        hasUnresolvedComplaints: complaints.length > 0,
                        priority: score > 70 ? '√éNALTƒÇ' : (score > 40 ? 'MEDIE' : 'SCƒÇZUTƒÇ')
                    });
                }
            });

            // Sortare dupƒÉ scor (descrescƒÉtor)
            lostClients.sort((a, b) => b.score - a.score);

            updateStatistics();
        }

        function calculateClientScore(client, complaints) {
            let score = 0;
            
            // 1. Vechime client (30% din scor)
            if (client.activeYears >= 5) score += 30;
            else if (client.activeYears >= 3) score += 20;
            else if (client.activeYears >= 1) score += 10;
            else score += 5;
            
            // 2. Frecven»õa comenzilor (25% din scor)
            if (client.ordersPerYear > 10) score += 25;
            else if (client.ordersPerYear >= 5) score += 20;
            else if (client.ordersPerYear >= 2) score += 15;
            else score += 10;
            
            // 3. Valoare totalƒÉ client (30% din scor)
            if (client.totalValue > 50000) score += 30;
            else if (client.totalValue >= 20000) score += 25;
            else if (client.totalValue >= 10000) score += 20;
            else if (client.totalValue >= 5000) score += 15;
            else score += 10;
            
            // 4. Tipul reclama»õiei/gravitate (15% din scor)
            if (complaints.length === 0) score += 15;
            else if (complaints.length <= 2) score += 10;
            else if (complaints.length <= 5) score += 5;
            else score += 0;
            
            return Math.min(100, score);
        }

        function updateStatistics() {
            const lostCount = lostClients.length;
            const complaintCount = lostClients.filter(c => c.complaints.length > 0).length;
            const lostRevenue = lostClients.reduce((sum, c) => sum + c.totalValue, 0);
            const voucherBudget = lostClients.reduce((sum, c) => sum + c.voucherAmount, 0);
            
            document.getElementById('lostCount').textContent = lostCount;
            document.getElementById('complaintCount').textContent = complaintCount;
            document.getElementById('lostRevenue').textContent = formatCurrency(lostRevenue);
            document.getElementById('voucherBudget').textContent = formatCurrency(voucherBudget);
        }

        function loadMoreClients() {
            if (isLoading || displayedClients >= lostClients.length) return;
            isLoading = true;
            
            const loadingMoreElement = document.getElementById('loadingMore');
            if (loadingMoreElement) loadingMoreElement.style.display = 'block';
            
            setTimeout(() => {
                const tbody = document.getElementById('tableBody');
                if (!tbody) return;
                
                const start = displayedClients;
                const end = Math.min(start + itemsPerLoad, lostClients.length);
                
                for (let i = start; i < end; i++) {
                    const client = lostClients[i];
                    const globalIndex = i + 1;
                    
                    const scoreColor = client.score > 70 ? 'green' : (client.score > 40 ? 'yellow' : 'red');
                    const priorityColor = client.priority === '√éNALTƒÇ' ? 'red' : (client.priority === 'MEDIE' ? 'yellow' : 'gray');
                    
                    const complaintsText = client.complaints.length > 0 ? 
                        client.complaints.map(c => `${c.reason}: ${c.description}`).join(' | ') : 
                        'FƒÉrƒÉ reclama»õii';
                    
                    const responsiblesText = client.complaints.length > 0 ? 
                        [...new Set(client.complaints.map(c => c.responsible))].join(', ') : 
                        '';

                    const row = `
                        <tr class="hover:bg-gray-50 ${client.hasUnresolvedComplaints ? 'bg-red-50' : ''}">
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ${String(globalIndex).padStart(2, '0')}
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm font-medium text-gray-900">${client.name}</div>
                                <div class="text-xs text-gray-500">ID: ${client.id}</div>
                                <div class="text-xs text-gray-500">${client.magazine}</div>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    ${client.lastPurchase ? client.lastPurchase.toLocaleDateString('ro-RO') : 'N/A'}
                                </div>
                                <div class="text-xs text-gray-500">
                                    ${Math.round(client.daysSinceLastPurchase)} zile
                                </div>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-sm font-semibold text-gray-900">${formatCurrency(client.totalValue)}</div>
                                <div class="text-xs text-gray-500">${client.totalOrders} comenzi</div>
                                <div class="text-xs text-gray-500">${client.activeYears.toFixed(1)} ani</div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="tooltip">
                                    <span class="text-sm ${client.complaints.length > 0 ? 'text-red-600' : 'text-green-600'}">
                                        ${client.complaints.length} reclama»õii
                                    </span>
                                    <div class="tooltip-content">
                                        <strong>Reclama»õii:</strong><br>
                                        ${complaintsText}<br><br>
                                        <strong>Responsabili:</strong><br>
                                        ${responsiblesText}
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-16 mr-2">
                                        <div class="score-bar">
                                            <div class="score-indicator" style="left: ${client.score}%"></div>
                                        </div>
                                    </div>
                                    <span class="text-sm font-medium text-${scoreColor}-600">${client.score}</span>
                                </div>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap">
                                <span class="text-sm font-semibold text-green-600">
                                    ${formatCurrency(client.voucherAmount)}
                                </span>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-${priorityColor}-100 text-${priorityColor}-800">
                                    ${client.priority}
                                </span>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
                
                displayedClients = end;
                isLoading = false;
                if (loadingMoreElement) {
                    loadingMoreElement.style.display = displayedClients >= lostClients.length ? 'none' : 'block';
                }
            }, 200);
        }

        // Infinite scroll
        window.addEventListener('scroll', () => {
            if (isLoading || displayedClients >= lostClients.length) return;
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                loadMoreClients();
            }
        });

        function exportData() {
            const exportData = lostClients.map((client, index) => ({
                'Nr': index + 1,
                'Client': client.name,
                'ID Client': client.id,
                'Magazin': client.magazine,
                'Ultima ComandƒÉ': client.lastPurchase ? client.lastPurchase.toLocaleDateString('ro-RO') : 'N/A',
                'Zile Inactivitate': Math.round(client.daysSinceLastPurchase),
                'Valoare TotalƒÉ': client.totalValue,
                'NumƒÉr Comenzi': client.totalOrders,
                'Ani Activitate': client.activeYears.toFixed(1),
                'Comenzi/An': client.ordersPerYear.toFixed(1),
                'Reclama»õii': client.complaints.length,
                'Scoring': client.score,
                'Voucher Recomandat': client.voucherAmount,
                'Prioritate': client.priority,
                'Descrieri Reclama»õii': client.complaints.map(c => c.description).join(' | '),
                'Responsabili': [...new Set(client.complaints.map(c => c.responsible))].join(', ')
            }));

            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Clien»õi Pierdu»õi');
            XLSX.writeFile(workbook, `clienti_pierduti_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('ro-RO', {
                style: 'currency',
                currency: 'RON',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }
    </script>
</body>
</html>
