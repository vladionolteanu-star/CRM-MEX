<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>Analiză Produse & Vânzări</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">

<div id="passwordOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-lg font-bold mb-4">Introdu Parola</h2>
    <input type="password" id="passwordInput" class="w-full p-2 border border-gray-300 rounded mb-4">
    <button onclick="checkPassword()" class="w-full bg-blue-600 text-white py-2 rounded">Accesează</button>
  </div>
</div>

<div class="flex flex-col h-screen hidden" id="mainContent">
  <!-- Sidebar -->
  <div class="w-full bg-gray-900 text-white flex flex-col">
    <div class="p-2 text-xl font-bold border-b border-gray-700">
      Analiză Produse
    </div>
    <div class="p-2 space-y-2 overflow-y-auto">
      <!-- Căutare -->
      <div>
        <label class="block text-xs font-medium mb-1">Caută Cod/Denumire</label>
        <input type="text" id="searchInput" placeholder="Caută..." 
          class="w-full p-1 bg-gray-800 border border-gray-600 rounded-lg text-xs text-white">
      </div>
      <!-- Upload Produse -->
      <div>
        <label class="block text-xs font-medium mb-1">Fișier Produse</label>
        <input type="file" id="uploadProducts" accept=".xlsx,.csv" 
          class="w-full text-xs text-gray-300 
          file:mr-1 file:py-0.5 file:px-2 file:rounded-lg file:border-0 
          file:text-xs file:bg-blue-600 file:text-white hover:file:bg-blue-700">
      </div>
      <!-- Upload Vânzări -->
      <div>
        <label class="block text-xs font-medium mb-1">Fișier Vânzări</label>
        <input type="file" id="uploadSales" accept=".xlsx,.csv" 
          class="w-full text-xs text-gray-300 
          file:mr-1 file:py-0.5 file:px-2 file:rounded-lg file:border-0 
          file:text-xs file:bg-green-600 file:text-white hover:file:bg-green-700">
      </div>
      <!-- Filtru An -->
      <div>
        <label class="block text-xs font-medium mb-1">Filtru An</label>
        <select id="filterYear" class="w-full p-1 bg-gray-800 border border-gray-600 rounded-lg text-xs"></select>
      </div>
      <!-- Filtru PM -->
      <div>
        <label class="block text-xs font-medium mb-1">Filtru PM</label>
        <select id="filterPM" class="w-full p-1 bg-gray-800 border border-gray-600 rounded-lg text-xs"></select>
      </div>
      <!-- Criteriu Top -->
      <div>
        <label class="block text-xs font-medium mb-1">Criteriu Top</label>
        <select id="topCriteria" class="w-full p-1 bg-gray-800 border border-gray-600 rounded-lg text-xs">
          <option value="valoare">Top Valoric</option>
          <option value="cantitate">Top Cantitativ</option>
          <option value="clienti">Top Nr. Clienți</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Zona principală -->
  <div class="flex-1 flex flex-col">
    <div class="p-2 bg-white border-b border-gray-200 flex items-center justify-between">
      <h1 class="text-lg font-bold">Dashboard Analiză Produse</h1>
      <div id="loadingBar" class="hidden w-64 bg-gray-200 rounded-full h-4 overflow-hidden">
        <div id="loadingProgress" class="h-4 bg-blue-600 w-0"></div>
      </div>
    </div>
    <div class="flex-1 overflow-y-auto p-2 space-y-4">
      <!-- Tabel -->
      <div class="bg-white rounded-lg shadow p-2">
        <h2 class="text-base font-bold mb-1">Topuri Produse</h2>
        <div class="overflow-x-auto">
          <table id="topTable" class="min-w-full text-xs text-left text-gray-700">
            <thead class="bg-gray-100 text-xs">
              <tr>
                <th class="px-2 py-1 w-16">#</th>
                <th class="px-2 py-1 w-24">Cod Articol</th>
                <th class="px-2 py-1 w-48">Denumire</th>
                <th class="px-2 py-1 w-24">PM</th>
                <th class="px-2 py-1 w-32">Valoare Facturată</th>
                <th class="px-2 py-1 w-24">Cantitate</th>
                <th class="px-2 py-1 w-24">Nr. Clienți</th>
                <th class="px-2 py-1 w-32">Preț Vânzare</th>
                <th class="px-2 py-1 w-32">Preț Achiziție</th>
                <th class="px-2 py-1 w-32">Profit Brut (%)</th>
                <th class="px-2 py-1 w-32">Furnizor Extern</th>
                <th class="px-2 py-1 w-48">Imagine</th>
              </tr>
            </thead>
            <tbody id="topTableBody"></tbody>
          </table>
        </div>
        <div id="pagination" class="mt-2"></div>
      </div>
      <!-- Chart -->
      <div class="bg-white rounded-lg shadow p-2">
        <h2 class="text-base font-bold mb-1">Analiză Distribuție</h2>
        <canvas id="pmChart" class="w-full h-80"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  function checkPassword() {
    const input = document.getElementById("passwordInput").value;
    if (input === "333") {
      document.getElementById("passwordOverlay").classList.add("hidden");
      document.getElementById("mainContent").classList.remove("hidden");
    } else {
      alert("Parolă greșită!");
    }
  }

  // ===================== VARIABILE GLOBALE =====================
  let productsData = [];
  let productsMap = {};
  let salesData = [];
  let mergedData = [];
  let pmChart = null;
  let currentPage = 1;
  const rowsPerPage = 100;

  // ===================== UTILE =====================
  function normalizeValue(val) {
    if (val === null || val === undefined || val === "" || val === "#null") {
      return "nu e disponibil";
    }
    return val;
  }

  function updateLoading(progress) {
    const bar = document.getElementById("loadingBar");
    const prog = document.getElementById("loadingProgress");
    bar.classList.remove("hidden");
    prog.style.width = progress + "%";
    if (progress >= 100) {
      setTimeout(() => bar.classList.add("hidden"), 800);
    }
  }

  async function loadImage(img) {
    if (!img.dataset.url || img.dataset.url === "nu e disponibil") {
      img.alt = "nu e disponibil";
      return;
    }
    try {
      const res = await fetch(img.dataset.url);
      const html = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const ogImage = doc.querySelector('meta[property="og:image"]')?.content;
      if (ogImage) {
        img.src = ogImage;
        img.dataset.loaded = ogImage;
      } else {
        img.alt = "no image";
      }
    } catch (e) {
      console.error(e);
      img.alt = "error";
    }
  }

  function getFilteredData() {
    const yearFilter = document.getElementById("filterYear").value;
    const pmFilter = document.getElementById("filterPM").value;
    const criteria = document.getElementById("topCriteria").value;
    const searchQuery = document.getElementById("searchInput").value.toLowerCase();

    let data = mergedData;
    if (yearFilter !== "all") data = data.filter(d => d.AN == yearFilter);
    if (pmFilter !== "all") data = data.filter(d => d.PM == pmFilter);
    if (searchQuery) {
      data = data.filter(d => 
        d.COD.toLowerCase().includes(searchQuery) || 
        d.DENUMIRE.toLowerCase().includes(searchQuery)
      );
    }

    if (criteria === "valoare") data.sort((a, b) => b.VALOARE - a.VALOARE);
    else if (criteria === "cantitate") data.sort((a, b) => b.CANTITATE - a.CANTITATE);
    else if (criteria === "clienti") data.sort((a, b) => b.CLIENTI - a.CLIENTI);

    return data;
  }

  // ===================== UPLOAD =====================
  document.getElementById("uploadProducts").addEventListener("change", e => {
    handleFileUpload(e.target.files[0], "products");
  });
  document.getElementById("uploadSales").addEventListener("change", e => {
    handleFileUpload(e.target.files[0], "sales");
  });

  function handleFileUpload(file, type) {
    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

      if (type === "products") {
        productsData = json.map(row => ({
          PM: normalizeValue(row["PM"]),
          COD: normalizeValue(row["COD ARTICOL"]),
          DENUMIRE: normalizeValue(row["DENUMIRE ARTICOL"]),
          FURNIZOR: normalizeValue(row["FURNIZOR"]),
          COST: normalizeValue(row["Cost Achizitie Furnizor (ultimul Document_cronologic)"]),
          FURNIZOR_EXT: normalizeValue(row["FURNIZOR EXT"]),
          URL: normalizeValue(row["URL ONLINE"]),
          NR_ART: normalizeValue(row["NR ART"]),
          PRET_VANZARE: normalizeValue(row["Pret Vanzare cu TVA (magazin _client final)"])
        }));
        productsMap = {};
        productsData.forEach(p => { productsMap[p.COD] = p; });
      } else {
        salesData = json.map(row => ({
          AN: normalizeValue(row["AN"]),
          COD: normalizeValue(row["COD ARTICOL"]),
          DENUMIRE: normalizeValue(row["DENUMIRE ARTICOL"]),
          PM: normalizeValue(row["PM"]),
          VALOARE: parseFloat(row["VALOARE FACTURATA"] || 0),
          CANTITATE: parseFloat(row["CANTITATE FACTURATA"] || 0),
          CLIENTI: parseFloat(row["NR CLIENTI"] || 0)
        }));
      }

      if (productsData.length && salesData.length) {
        mergeDatasets();
      }
    };
    reader.readAsArrayBuffer(file);
  }

  // ===================== MERGE DATASETS =====================
  function mergeDatasets() {
    updateLoading(0);

    let temp = {};
    let idx = 0;
    let batchSize = 10000;

    function processBatch() {
      const end = Math.min(idx + batchSize, salesData.length);
      for (; idx < end; idx++) {
        const s = salesData[idx];
        if (!temp[s.COD]) {
          temp[s.COD] = {
            COD: s.COD,
            DENUMIRE: s.DENUMIRE,
            PM: s.PM,
            VALOARE: 0,
            CANTITATE: 0,
            CLIENTI: 0,
            AN: s.AN
          };
        }
        temp[s.COD].VALOARE += s.VALOARE;
        temp[s.COD].CANTITATE += s.CANTITATE;
        temp[s.COD].CLIENTI += s.CLIENTI;
      }

      updateLoading(Math.floor((idx / salesData.length) * 90));

      if (idx < salesData.length) {
        setTimeout(processBatch, 0);
      } else {
        mergedData = Object.values(temp).map(item => {
          const p = productsMap[item.COD] || {};
          const pretVanzare = p.PRET_VANZARE !== "nu e disponibil" && p.PRET_VANZARE ? parseFloat(p.PRET_VANZARE) : item.CANTITATE > 0 ? (item.VALOARE / item.CANTITATE) : 0;
          const cost = p.COST !== "nu e disponibil" && p.COST ? parseFloat(p.COST) : 0;
          const profitBrut = (pretVanzare > 0 && cost > 0) ? ((pretVanzare - cost) / pretVanzare * 100).toFixed(2) : "nu e disponibil";
          return {
            ...item,
            PRET_VANZARE: pretVanzare > 0 ? pretVanzare.toFixed(2) : "nu e disponibil",
            URL: p.URL || "nu e disponibil",
            COST: cost > 0 ? cost.toFixed(2) : "nu e disponibil",
            FURNIZOR_EXT: p.FURNIZOR_EXT || "nu e disponibil",
            PROFIT_BRUT: profitBrut
          };
        });

        updateLoading(100);
        populateFilters();
        renderTopTable();
      }
    }

    processBatch();
  }

  // ===================== FILTRE & SEARCH =====================
  function populateFilters() {
    const yearSelect = document.getElementById("filterYear");
    const pmSelect = document.getElementById("filterPM");

    const years = [...new Set(salesData.map(s => s.AN))];
    yearSelect.innerHTML = '<option value="all">Toate</option>';
    years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);

    const pms = [...new Set(productsData.map(p => p.PM))];
    pmSelect.innerHTML = '<option value="all">Toate</option>';
    pms.forEach(pm => pmSelect.innerHTML += `<option value="${pm}">${pm}</option>`);
  }

  document.getElementById("filterYear").addEventListener("change", () => { currentPage = 1; renderTopTable(); });
  document.getElementById("filterPM").addEventListener("change", () => { currentPage = 1; renderTopTable(); });
  document.getElementById("topCriteria").addEventListener("change", () => { currentPage = 1; renderTopTable(); });
  document.getElementById("searchInput").addEventListener("input", () => { currentPage = 1; renderTopTable(); });

  // ===================== TABEL CU PAGINARE =====================
  function renderTopTable() {
    const yearFilter = document.getElementById("filterYear").value;
    const pmFilter = document.getElementById("filterPM").value;
    const criteria = document.getElementById("topCriteria").value;

    let data = getFilteredData();
    const totalPages = Math.ceil(data.length / rowsPerPage);
    const start = (currentPage - 1) * rowsPerPage;
    const pagedData = data.slice(start, start + rowsPerPage);

    const tbody = document.getElementById("topTableBody");
    tbody.innerHTML = pagedData.map((d, idx) => `
      <tr class="border-b hover:bg-gray-50 text-xs">
        <td class="px-2 py-3 w-16">${start + idx + 1}</td>
        <td class="px-2 py-3 w-24">${d.COD}</td>
        <td class="px-2 py-3 w-48">${d.DENUMIRE}</td>
        <td class="px-2 py-3 w-24">${d.PM}</td>
        <td class="px-2 py-3 w-32 font-semibold">${d.VALOARE.toFixed(0)}</td>
        <td class="px-2 py-3 w-24">${d.CANTITATE.toFixed(0)}</td>
        <td class="px-2 py-3 w-24">${d.CLIENTI}</td>
        <td class="px-2 py-3 w-32">${d.PRET_VANZARE}</td>
        <td class="px-2 py-3 w-32">${d.COST}</td>
        <td class="px-2 py-3 w-32">${d.PROFIT_BRUT}%</td>
        <td class="px-2 py-3 w-32">${d.FURNIZOR_EXT}</td>
        <td class="px-2 py-3 w-48">
          ${d.URL && d.URL !== "nu e disponibil"
            ? `<a href="${d.URL}" target="_blank">
                 <img data-url="${d.URL}" class="w-64 h-64 object-contain rounded-lg shadow border">
               </a>`
            : "nu e disponibil"}
        </td>
      </tr>`).join("");

    const images = document.querySelectorAll('#topTableBody img');
    Promise.all(Array.from(images).map(img => loadImage(img).then(() => new Promise(res => img.onload = res))));

    const pagination = document.getElementById("pagination");
    pagination.innerHTML = `
      <div class="flex justify-between items-center text-xs mt-2">
        <button ${currentPage === 1 ? "disabled" : ""} 
          onclick="prevPage()" 
          class="px-2 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50">Prev</button>
        <span class="font-medium">Pagina ${currentPage} din ${totalPages}</span>
        <button ${currentPage === totalPages ? "disabled" : ""} 
          onclick="nextPage(${totalPages})" 
          class="px-2 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50">Next</button>
      </div>`;

    renderChart(data);
  }

  function nextPage(total) {
    if (currentPage < total) { currentPage++; renderTopTable(); }
  }
  function prevPage() {
    if (currentPage > 1) { currentPage--; renderTopTable(); }
  }

  // ===================== CHART (Pie + Bar) =====================
  function renderChart(data) {
    const pmFilter = document.getElementById("filterPM").value;

    if (pmChart) pmChart.destroy();
    const ctx = document.getElementById("pmChart").getContext("2d");

    if (pmFilter === "all") {
      const pmGroups = {};
      data.forEach(d => { pmGroups[d.PM] = (pmGroups[d.PM] || 0) + d.VALOARE; });
      pmChart = new Chart(ctx, {
        type: "pie",
        data: { labels: Object.keys(pmGroups), datasets: [{ data: Object.values(pmGroups) }] },
        options: { responsive: true, plugins: { legend: { position: "right" } } }
      });
    } else {
      const topData = [...data].filter(d => d.PM === pmFilter).sort((a, b) => b.VALOARE - a.VALOARE).slice(0, 100);
      pmChart = new Chart(ctx, {
        type: "bar",
        data: { labels: topData.map(d => d.COD), datasets: [{ label: "Valoare Facturată", data: topData.map(d => d.VALOARE), backgroundColor: "#2563eb" }] },
        options: { responsive: true, indexAxis: "y", plugins: { legend: { display: false } }, scales: { x: { ticks: { precision: 0 } } } }
      });
    }
  }
</script>

</body>
</html>
