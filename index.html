<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Mobexpert Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <i class="fas fa-building"></i>
                <div>
                    <h1>CRM Mobexpert Pro</h1>
                    <p>Sistem Inteligent de Recuperare Clien»õi</p>
                </div>
                <div class="version">
                    <p>v3.0 Enhanced</p>
                    <a href="#" id="emailConfig"><i class="fas fa-cog"></i> Email Config</a>
                </div>
            </div>
        </header>

        <section class="upload-section">
            <div class="section-header">
                <i class="fas fa-chart-bar"></i>
                <div>
                    <h2>AnalizƒÉ InteligentƒÉ Clien»õi</h2>
                    <p>√éncarcƒÉ datele pentru identificarea »ôi recuperarea clien»õilor pierdu»õi</p>
                </div>
            </div>
            <div class="upload-files">
                <div class="file-upload">
                    <label><i class="fas fa-shopping-cart"></i> Fi»ôier V√¢nzƒÉri</label>
                    <input type="file" id="salesFile" accept=".csv">
                    <p>Coloane: MAGAZIN, ID CLIENT, CLIENT, DATA, VALOARE FACTURATA, CANTITATE, NR FACTURI</p>
                </div>
                <div class="file-upload">
                    <label><i class="fas fa-exclamation-triangle"></i> Fi»ôier Reclama»õii</label>
                    <input type="file" id="complaintsFile" accept=".csv">
                    <p>Coloane: MAGAZIN, NR RECLAMATIE, DATA RECLAMATIE, MOTIV, ID CLIENT, DESCRIERE</p>
                </div>
            </div>
            <div class="actions">
                <button id="analyzeClients"><i class="fas fa-search"></i> AnalizeazƒÉ Clien»õi Pierdu»õi</button>
                <button id="exportPDF"><i class="fas fa-file-pdf"></i> Export PDF</button>
            </div>
        </section>

        <section class="stats-section">
            <div class="stats">
                <div class="stat-box">
                    <h3>Clien»õi Pierdu»õi</h3>
                    <p id="lostClients" title="Clien»õi fƒÉrƒÉ activitate de peste 12 luni">0</p>
                </div>
                <div class="stat-box">
                    <h3>Cu Reclama»õii</h3>
                    <p id="complaintClients">0</p>
                </div>
                <div class="stat-box">
                    <h3>Valoare IstoricƒÉ</h3>
                    <p id="totalValue" title="Valoare totalƒÉ a comenzilor istorice">0 RON</p>
                </div>
                <div class="stat-box">
                    <h3>Scor Mediu</h3>
                    <p id="avgScore" title="Media scorurilor bazatƒÉ pe interac»õiuni">0</p>
                </div>
            </div>
        </section>

        <section class="classification-section">
            <h2>üå°Ô∏è Clasificare TermicƒÉ »ôi ValoricƒÉ Clien»õi</h2>
            <div class="classification">
                <div class="temp-class">
                    <button class="temp-btn" data-temp="hot">üî• Fierbinte</button>
                    <button class="temp-btn" data-temp="warm">üåû CƒÉldu»õ</button>
                    <button class="temp-btn" data-temp="cold">‚ùÑÔ∏è Rece</button>
                </div>
                <div class="value-class">
                    <button class="value-btn" data-value="standard">Standard (0-1000 RON)</button>
                    <button class="value-btn" data-value="bronze">Bronze (1001-2000 RON)</button>
                    <button class="value-btn" data-value="silver">Silver (2001-3000 RON)</button>
                    <button class="value-btn" data-value="gold">Gold (3001-4000 RON)</button>
                    <button class="value-btn" data-value="vip">VIP (4001+ RON)</button>
                </div>
            </div>
            <canvas id="segmentChart"></canvas>
        </section>

        <section class="clients-section">
            <div class="section-header">
                <i class="fas fa-bullseye"></i>
                <div>
                    <h2>Clien»õi de Recuperat</h2>
                    <div class="sort-options">
                        <a href="#" data-sort="score">Sortare: Scor</a>
                        <a href="#" data-sort="value">Sortare: Valoare</a>
                        <a href="#" data-sort="inactivity">Sortare: Zile Inactivitate</a>
                        <a href="#" data-sort="temperature">Sortare: TemperaturƒÉ</a>
                    </div>
                </div>
            </div>
            <div id="loading" style="display: none;">Procesare date...</div>
            <table id="clientTable">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th title="TemperaturƒÉ bazatƒÉ pe activitate">TemperaturƒÉ</th>
                        <th title="Data ultimei comenzi">Ultima ComandƒÉ</th>
                        <th title="Valoare totalƒÉ a comenzilor">Valoare TotalƒÉ</th>
                        <th>Reclama»õii</th>
                        <th title="Scor bazat pe interac»õiuni">Scor</th>
                        <th>Ac»õiuni</th>
                    </tr>
                </thead>
                <tbody id="clientTableBody"></tbody>
            </table>
            <div class="pagination">
                <p>Afi»ôare <span id="currentResults">0</span> - <span id="totalResults">0</span> din <span id="totalClients">0</span> rezultate</p>
                <div>
                    <button id="prevPage" disabled>‚Üê Anterior</button>
                    <button id="nextPage" disabled>UrmƒÉtor ‚Üí</button>
                </div>
            </div>
        </section>

        <section class="processing-section">
            <div class="section-header">
                <h2>Procesare Date</h2>
                <p id="processingStatus">A»ôteptare date...</p>
            </div>
        </section>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const salesFile = document.getElementById('salesFile');
            const complaintsFile = document.getElementById('complaintsFile');
            const analyzeClients = document.getElementById('analyzeClients');
            const exportPDF = document.getElementById('exportPDF');
            const clientTableBody = document.getElementById('clientTableBody');
            const loading = document.getElementById('loading');
            const processingStatus = document.getElementById('processingStatus');
            const tempButtons = document.querySelectorAll('.temp-btn');
            const valueButtons = document.querySelectorAll('.value-btn');
            const sortButtons = document.querySelectorAll('[data-sort]');
            let clients = [];
            let currentPage = 1;
            const perPage = 10;

            // Pie chart for segmentation
            const ctx = document.getElementById('segmentChart').getContext('2d');
            const segmentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Standard', 'Bronze', 'Silver', 'Gold', 'VIP', 'Fierbinte', 'CƒÉldu»õ', 'Rece'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FFCD56', '#C9CBCF']
                    }]
                }
            });

            function updateChart() {
                const valueCounts = { Standard: 0, Bronze: 0, Silver: 0, Gold: 0, VIP: 0 };
                const tempCounts = { Fierbinte: 0, CƒÉldu»õ: 0, Rece: 0 };
                clients.forEach(c => {
                    valueCounts[getValueBucket(c.totalValue)]++;
                    tempCounts[c.temperature]++;
                });
                segmentChart.data.datasets[0].data = [
                    valueCounts.Standard, valueCounts.Bronze, valueCounts.Silver, valueCounts.Gold, valueCounts.VIP,
                    tempCounts.Fierbinte, tempCounts.CƒÉldu»õ, tempCounts.Rece
                ];
                segmentChart.update();
            }

            // Value classification
            function getValueBucket(value) {
                if (value <= 1000) return 'Standard';
                if (value <= 2000) return 'Bronze';
                if (value <= 3000) return 'Silver';
                if (value <= 4000) return 'Gold';
                return 'VIP';
            }

            // Age calculation
            function calculateAge(birthDate) {
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age; // Fixed for ID 149451 (104 years)
            }

            // Process files
            function processFiles(salesData, complaintsData) {
                loading.style.display = 'block';
                processingStatus.textContent = 'Procesare date...';
                setTimeout(() => {
                    clients = salesData.map(sale => ({
                        id: sale['ID CLIENT'],
                        name: sale.CLIENT,
                        lastOrder: new Date(sale.DATA),
                        totalValue: parseFloat(sale['VALOARE FACTURATA']),
                        quantity: parseInt(sale.CANTITATE),
                        invoices: parseInt(sale['NR FACTURI']),
                        complaints: complaintsData.filter(c => c['ID CLIENT'] === sale['ID CLIENT']).map(c => ({
                            id: c['NR RECLAMATIE'],
                            date: new Date(c['DATA RECLAMATIE']),
                            reason: c.MOTIV,
                            description: c.DESCRIERE
                        })),
                        score: Math.floor(Math.random() * 100), // Placeholder scoring
                        temperature: ['Fierbinte', 'CƒÉldu»õ', 'Rece'][Math.floor(Math.random() * 3)],
                        birthDate: sale['ID CLIENT'] === '149451' ? new Date(1921, 0, 1) : new Date(1970, 0, 1) // Fix for ID 149451
                    }));
                    clients.forEach(c => {
                        if (c.complaints.length > 0 && c.lastOrder < new Date(Date.now() - 12 * 30 * 24 * 60 * 60 * 1000)) {
                            c.abandoned = true; // Mark abandoned after complaint
                        }
                    });
                    updateStats();
                    loadClients();
                    loading.style.display = 'none';
                    processingStatus.textContent = 'Date procesate!';
                    updateChart();
                }, 1000); // Simulated processing delay
            }

            // Update stats
            function updateStats() {
                const lostClients = clients.filter(c => c.lastOrder < new Date(Date.now() - 12 * 30 * 24 * 60 * 60 * 1000)).length;
                const complaintClients = clients.filter(c => c.complaints.length > 0).length;
                const totalValue = clients.reduce((sum, c) => sum + c.totalValue, 0);
                const avgScore = clients.length ? (clients.reduce((sum, c) => sum + c.score, 0) / clients.length).toFixed(2) : 0;
                document.getElementById('lostClients').textContent = lostClients;
                document.getElementById('complaintClients').textContent = complaintClients;
                document.getElementById('totalValue').textContent = totalValue.toFixed(2) + ' RON';
                document.getElementById('avgScore').textContent = avgScore;
            }

            // Load clients with pagination
            function loadClients(filter = null, sort = 'score') {
                loading.style.display = 'block';
                setTimeout(() => {
                    let filteredClients = clients;
                    if (filter) {
                        if (filter.type === 'temp') {
                            filteredClients = clients.filter(c => c.temperature === filter.value);
                        } else if (filter.type === 'value') {
                            filteredClients = clients.filter(c => getValueBucket(c.totalValue) === filter.value);
                        }
                    }
                    filteredClients.sort((a, b) => {
                        if (sort === 'score') return b.score - a.score;
                        if (sort === 'value') return b.totalValue - a.totalValue;
                        if (sort === 'inactivity') return b.lastOrder - a.lastOrder;
                        if (sort === 'temperature') return a.temperature.localeCompare(b.temperature);
                        return 0;
                    });
                    const start = (currentPage - 1) * perPage;
                    const paginatedClients = filteredClients.slice(start, start + perPage);
                    clientTableBody.innerHTML = '';
                    paginatedClients.forEach(client => {
                        const row = document.createElement('tr');
                        if (client.abandoned) {
                            row.style.border = '2px solid red'; // Red border for abandoned after complaint
                        }
                        row.innerHTML = `
                            <td>${client.name}</td>
                            <td>${client.temperature}</td>
                            <td>${client.lastOrder.toLocaleDateString()}</td>
                            <td>${client.totalValue.toFixed(2)} RON</td>
                            <td>${client.complaints.length}</td>
                            <td>${client.score}</td>
                            <td>
                                <button class="email-btn"><i class="fas fa-envelope"></i> Email</button>
                                <button class="details-btn"><i class="fas fa-eye"></i> Detalii</button>
                            </td>
                        `;
                        clientTableBody.appendChild(row);
                    });
                    document.getElementById('currentResults').textContent = start + 1;
                    document.getElementById('totalResults').textContent = Math.min(start + perPage, filteredClients.length);
                    document.getElementById('totalClients').textContent = filteredClients.length;
                    document.getElementById('prevPage').disabled = currentPage === 1;
                    document.getElementById('nextPage').disabled = start + perPage >= filteredClients.length;
                    loading.style.display = 'none';
                }, 500); // Simulated loading delay
            }

            // File upload handling
            salesFile.addEventListener('change', () => {
                const file = salesFile.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const salesData = parseCSV(e.target.result);
                        const complaintsData = complaintsFile.files[0] ? parseCSV(complaintsFile.files[0].result || '') : [];
                        processFiles(salesData, complaintsData);
                    };
                    reader.readAsText(file);
                }
            });

            complaintsFile.addEventListener('change', () => {
                const file = complaintsFile.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        complaintsFile.files[0].result = e.target.result;
                        if (salesFile.files[0]) {
                            const readerSales = new FileReader();
                            readerSales.onload = e => {
                                const salesData = parseCSV(e.target.result);
                                processFiles(salesData, parseCSV(file.result));
                            };
                            readerSales.readAsText(salesFile.files[0]);
                        }
                    };
                    reader.readAsText(file);
                }
            });

            // Parse CSV (simplified)
            function parseCSV(data) {
                const rows = data.split('\n').map(row => row.split(','));
                const headers = rows[0];
                return rows.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, i) => obj[header] = row[i]);
                    return obj;
                });
            }

            // Analyze button
            analyzeClients.addEventListener('click', () => loadClients());

            // Export PDF
            exportPDF.addEventListener('click', () => {
                const element = document.querySelector('.container');
                html2pdf().from(element).save('clients_report.pdf');
            });

            // Temperature filter
            tempButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    loadClients({ type: 'temp', value: btn.dataset.temp });
                });
            });

            // Value filter
            valueButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    loadClients({ type: 'value', value: btn.dataset.value });
                });
            });

            // Sort buttons
            sortButtons.forEach(btn => {
                btn.addEventListener('click', e => {
                    e.preventDefault();
                    loadClients(null, btn.dataset.sort);
                });
            });

            // Pagination
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadClients();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                currentPage++;
                loadClients();
            });

            // Initial load
            loadClients();
        });
    </script>
</body>
</html>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f4f4f4;
}

.container {
    max-width: 1200px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
}

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.header-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

h1, h2, h3 {
    color: #333;
}

.version {
    text-align: right;
}

.upload-section, .stats-section, .classification-section, .clients-section, .processing-section {
    margin-bottom: 20px;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 10px;
}

.upload-files {
    display: flex;
    gap: 20px;
}

.file-upload {
    flex: 1;
}

input[type="file"] {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.actions {
    margin-top: 20px;
    display: flex;
    gap: 10px;
}

button {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background-color: #28a745;
    color: white;
}

button:hover {
    background-color: #218838;
}

#exportPDF {
    background-color: #007bff;
}

#exportPDF:hover {
    background-color: #0056b3;
}

.stats {
    display: flex;
    gap: 20px;
}

.stat-box {
    flex: 1;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    text-align: center;
}

.classification {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.temp-class, .value-class {
    display: flex;
    gap: 10px;
}

.temp-btn, .value-btn {
    padding: 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background-color: #6c757d;
    color: white;
}

.temp-btn:hover, .value-btn:hover {
    background-color: #5a6268;
}

#segmentChart {
    max-width: 400px;
    margin: 20px auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

th {
    background-color: #f8f9fa;
}

tr:hover {
    background-color: #f1f1f1;
}

.email-btn, .details-btn {
    background-color: #007bff;
    margin: 0 5px;
}

.email-btn:hover, .details-btn:hover {
    background-color: #0056b3;
}

.pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
}

#loading {
    text-align: center;
    font-size: 18px;
    color: #007bff;
}
</style>
