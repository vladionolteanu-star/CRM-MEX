<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>Analiză Produse & Vânzări</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    #matrixCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    .login-content {
      position: relative;
      z-index: 10;
    }
    #processingMatrix {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      display: none;
    }
    #processingContent {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10000;
      text-align: center;
    }
  </style>
</head>
<body class="bg-gray-100">

<!-- Matrix Rain pentru procesare -->
<div id="processingMatrix">
  <canvas id="processingMatrixCanvas"></canvas>
  <div id="processingContent">
    <div class="bg-black/50 backdrop-blur-sm p-8 rounded-lg border border-green-500/30">
      <h2 class="text-2xl font-bold text-green-400 mb-4 font-mono">PROCESARE DATE</h2>
      <div class="w-64 bg-gray-800 rounded-full h-4 overflow-hidden border border-green-500/30">
        <div id="processingProgress" class="h-4 bg-gradient-to-r from-green-600 to-green-400 w-0 transition-all duration-300"></div>
      </div>
      <p class="text-green-400 mt-4 font-mono text-sm" id="processingText">Inițializare...</p>
    </div>
  </div>
</div>

<!-- Ecran de logare cu Matrix Rain -->
<div id="passwordOverlay" class="fixed inset-0 bg-black flex items-center justify-center z-50">
  <canvas id="matrixCanvas"></canvas>
  <div class="login-content bg-black/80 backdrop-blur-md p-8 rounded-lg shadow-2xl border border-green-500/30">
    <h2 class="text-2xl font-bold mb-6 text-green-400 font-mono text-center">SISTEM SECURIZAT</h2>
    <div class="space-y-4">
      <input type="password" id="passwordInput" 
        class="w-full p-3 bg-black/50 border border-green-500/50 rounded text-green-400 font-mono placeholder-green-600/50 focus:border-green-400 focus:outline-none"
        placeholder="INTRODU CODUL">
      <button onclick="checkPassword()" 
        class="w-full bg-gradient-to-r from-green-600 to-green-500 text-black font-bold py-3 rounded font-mono hover:from-green-500 hover:to-green-400 transition-all duration-300 shadow-lg">
        ACCESEAZĂ SISTEMUL
      </button>
    </div>
    <div class="mt-4 text-center">
      <p class="text-green-500/50 text-xs font-mono">SECURE CONNECTION ESTABLISHED</p>
    </div>
  </div>
</div>

<div class="flex flex-col h-screen hidden" id="mainContent">
  <!-- Sidebar -->
  <div class="w-full bg-gray-900 text-white flex flex-col">
    <div class="p-2 text-xl font-bold border-b border-gray-700">
      Analiză Produse
    </div>
    <div class="p-2 space-y-2 overflow-y-auto">
      <!-- Căutare -->
      <div>
        <label class="block text-xs font-medium mb-1">Caută Cod/Denumire</label>
        <input type="text" id="searchInput" placeholder="Caută..." 
          class="w-full p-1 bg-gray-800 border border-gray-600 rounded-lg text-xs text-white">
      </div>
      <!-- Upload Produse -->
      <div>
        <label class="block text-xs font-medium mb-1">Fișier Produse</label>
        <input type="file" id="uploadProducts" accept=".xlsx,.csv" 
          class="w-full text-xs text-gray-300 
          file:mr-1 file:py-0.5 file:px-2 file:rounded-lg file:border-0 
          file:text-xs file:bg-blue-600 file:text-white hover:file:bg-blue-700">
      </div>
      <!-- Upload Vânzări -->
      <div>
        <label class="block text-xs font-medium mb-1">Fișier Vânzări</label>
        <input type="file" id="uploadSales" accept=".xlsx,.csv" 
          class="w-full text-xs text-gray-300 
          file:mr-1 file:py-0.5 file:px-2 file:rounded-lg file:border-0 
          file:text-xs file:bg-green-600 file:text-white hover:file:bg-green-700">
      </div>
      <!-- Filtru An -->
      <div>
        <label class="block text-xs font-medium mb-1">Filtru An</label>
        <select id="filterYear" class="w-full p-1 bg-gray-800 border border-gray-600 rounded-lg text-xs"></select>
      </div>
      <!-- Filtru PM -->
      <div>
        <label class="block text-xs font-medium mb-1">Filtru PM</label>
        <select id="filterPM" class="w-full p-1 bg-gray-800 border border-gray-600 rounded-lg text-xs"></select>
      </div>
      <!-- Criteriu Top -->
      <div>
        <label class="block text-xs font-medium mb-1">Criteriu Top</label>
        <select id="topCriteria" class="w-full p-1 bg-gray-800 border border-gray-600 rounded-lg text-xs">
          <option value="valoare">Top Valoric</option>
          <option value="cantitate">Top Cantitativ</option>
          <option value="clienti">Top Nr. Clienți</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Zona principală -->
  <div class="flex-1 flex flex-col">
    <div class="p-2 bg-white border-b border-gray-200 flex items-center justify-between">
      <h1 class="text-lg font-bold">Dashboard Analiză Produse</h1>
      <div id="loadingBar" class="hidden w-64 bg-gray-200 rounded-full h-4 overflow-hidden">
        <div id="loadingProgress" class="h-4 bg-blue-600 w-0"></div>
      </div>
    </div>
    <div class="flex-1 overflow-y-auto p-2 space-y-4">
      <!-- Tabel -->
      <div class="bg-white rounded-lg shadow p-2">
        <h2 class="text-base font-bold mb-1">Topuri Produse</h2>
        <div class="overflow-x-auto">
          <table id="topTable" class="min-w-full text-xs text-left text-gray-700">
            <thead class="bg-gray-100 text-xs">
              <tr>
                <th class="px-2 py-1 w-16">#</th>
                <th class="px-2 py-1 w-24">Cod Articol</th>
                <th class="px-2 py-1 w-48">Denumire</th>
                <th class="px-2 py-1 w-24">PM</th>
                <th class="px-2 py-1 w-32">Valoare Facturată</th>
                <th class="px-2 py-1 w-24">Cantitate</th>
                <th class="px-2 py-1 w-24">Nr. Clienți</th>
                <th class="px-2 py-1 w-32">Preț Vânzare</th>
                <th class="px-2 py-1 w-32">Preț Achiziție</th>
                <th class="px-2 py-1 w-32">Profit Brut (%)</th>
                <th class="px-2 py-1 w-32">Furnizor Extern</th>
                <th class="px-2 py-1 w-48">Imagine</th>
              </tr>
            </thead>
            <tbody id="topTableBody"></tbody>
          </table>
        </div>
        <div id="pagination" class="mt-2"></div>
      </div>
      <!-- Chart -->
      <div class="bg-white rounded-lg shadow p-2">
        <h2 class="text-base font-bold mb-1">Analiză Distribuție</h2>
        <canvas id="pmChart" class="w-full h-80"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  // ===================== MATRIX RAIN EFFECT =====================
  class MatrixRain {
    constructor(canvasId) {
      this.canvas = document.getElementById(canvasId);
      this.ctx = this.canvas.getContext('2d');
      this.fontSize = 14;
      this.columns = 0;
      this.drops = [];
      this.chars = '01アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン';
      this.running = false;
      
      this.resize();
      window.addEventListener('resize', () => this.resize());
    }
    
    resize() {
      this.canvas.width = window.innerWidth;
      this.canvas.height = window.innerHeight;
      this.columns = Math.floor(this.canvas.width / this.fontSize);
      this.drops = Array(this.columns).fill(1);
    }
    
    start() {
      this.running = true;
      this.draw();
    }
    
    stop() {
      this.running = false;
    }
    
    draw() {
      if (!this.running) return;
      
      this.ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
      this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
      
      this.ctx.fillStyle = '#0F0';
      this.ctx.font = this.fontSize + 'px monospace';
      
      for (let i = 0; i < this.drops.length; i++) {
        const text = this.chars[Math.floor(Math.random() * this.chars.length)];
        this.ctx.fillText(text, i * this.fontSize, this.drops[i] * this.fontSize);
        
        if (this.drops[i] * this.fontSize > this.canvas.height && Math.random() > 0.975) {
          this.drops[i] = 0;
        }
        this.drops[i]++;
      }
      
      requestAnimationFrame(() => this.draw());
    }
  }

  // Inițializare Matrix Rain pentru login
  const loginMatrix = new MatrixRain('matrixCanvas');
  loginMatrix.start();
  
  // Matrix Rain pentru procesare
  const processingMatrix = new MatrixRain('processingMatrixCanvas');

  // Focus automat pe input parolă
  document.getElementById('passwordInput').focus();
  
  // Enter key pentru submit
  document.getElementById('passwordInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') checkPassword();
  });

  function checkPassword() {
    const input = document.getElementById("passwordInput").value;
    if (input === "333") {
      // Efect de fade out pentru Matrix
      const overlay = document.getElementById("passwordOverlay");
      overlay.style.transition = "opacity 0.5s";
      overlay.style.opacity = "0";
      
      setTimeout(() => {
        loginMatrix.stop();
        overlay.classList.add("hidden");
        document.getElementById("mainContent").classList.remove("hidden");
      }, 500);
    } else {
      // Efect de shake pentru input greșit
      const input = document.getElementById("passwordInput");
      input.style.animation = "shake 0.5s";
      input.style.borderColor = "#ef4444";
      setTimeout(() => {
        input.style.animation = "";
        input.style.borderColor = "";
        input.value = "";
        input.focus();
      }, 500);
    }
  }

  // Animație shake
  const style = document.createElement('style');
  style.textContent = `
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
  `;
  document.head.appendChild(style);

  // ===================== VARIABILE GLOBALE =====================
  let productsData = [];
  let productsMap = {};
  let salesData = [];
  let mergedData = [];
  let pmChart = null;
  let currentPage = 1;
  const rowsPerPage = 100;
  let hasFirstFile = false;

  // ===================== UTILE =====================
  function normalizeValue(val) {
    if (val === null || val === undefined || val === "" || val === "#null") {
      return "nu e disponibil";
    }
    return val;
  }

  function updateLoading(progress) {
    const bar = document.getElementById("loadingBar");
    const prog = document.getElementById("loadingProgress");
    bar.classList.remove("hidden");
    prog.style.width = progress + "%";
    if (progress >= 100) {
      setTimeout(() => bar.classList.add("hidden"), 800);
    }
  }

  function showProcessingMatrix(progress, text = "Procesare...") {
    const container = document.getElementById("processingMatrix");
    const progressBar = document.getElementById("processingProgress");
    const progressText = document.getElementById("processingText");
    
    container.style.display = "block";
    progressBar.style.width = progress + "%";
    progressText.textContent = text;
    
    if (!processingMatrix.running) {
      processingMatrix.start();
    }
    
    if (progress >= 100) {
      setTimeout(() => {
        container.style.display = "none";
        processingMatrix.stop();
      }, 1000);
    }
  }

  async function loadImage(img) {
    if (!img.dataset.url || img.dataset.url === "nu e disponibil") {
      img.alt = "nu e disponibil";
      return;
    }
    try {
      const res = await fetch(img.dataset.url);
      const html = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const ogImage = doc.querySelector('meta[property="og:image"]')?.content;
      if (ogImage) {
        img.src = ogImage;
        img.dataset.loaded = ogImage;
      } else {
        img.alt = "no image";
      }
    } catch (e) {
      console.error(e);
      img.alt = "error";
    }
  }

  function getFilteredData() {
    const yearFilter = document.getElementById("filterYear").value;
    const pmFilter = document.getElementById("filterPM").value;
    const criteria = document.getElementById("topCriteria").value;
    const searchQuery = document.getElementById("searchInput").value.toLowerCase();

    let data = mergedData;
    if (yearFilter !== "all") data = data.filter(d => d.AN == yearFilter);
    if (pmFilter !== "all") data = data.filter(d => d.PM == pmFilter);
    if (searchQuery) {
      data = data.filter(d => 
        d.COD.toLowerCase().includes(searchQuery) || 
        d.DENUMIRE.toLowerCase().includes(searchQuery)
      );
    }

    if (criteria === "valoare") data.sort((a, b) => b.VALOARE - a.VALOARE);
    else if (criteria === "cantitate") data.sort((a, b) => b.CANTITATE - a.CANTITATE);
    else if (criteria === "clienti") data.sort((a, b) => b.CLIENTI - a.CLIENTI);

    return data;
  }

  // ===================== UPLOAD =====================
  document.getElementById("uploadProducts").addEventListener("change", e => {
    handleFileUpload(e.target.files[0], "products");
  });
  document.getElementById("uploadSales").addEventListener("change", e => {
    handleFileUpload(e.target.files[0], "sales");
  });

  function handleFileUpload(file, type) {
    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

      if (type === "products") {
        productsData = json.map(row => ({
          PM: normalizeValue(row["PM"]),
          COD: normalizeValue(row["COD ARTICOL"]),
          DENUMIRE: normalizeValue(row["DENUMIRE ARTICOL"]),
          FURNIZOR: normalizeValue(row["FURNIZOR"]),
          COST: normalizeValue(row["Cost Achizitie Furnizor (ultimul Document_cronologic)"]),
          FURNIZOR_EXT: normalizeValue(row["FURNIZOR EXT"]),
          URL: normalizeValue(row["URL ONLINE"]),
          NR_ART: normalizeValue(row["NR ART"]),
          PRET_VANZARE: normalizeValue(row["Pret Vanzare cu TVA (magazin _client final)"])
        }));
        productsMap = {};
        productsData.forEach(p => { productsMap[p.COD] = p; });
        hasFirstFile = true;
      } else {
        salesData = json.map(row => ({
          AN: normalizeValue(row["AN"]),
          COD: normalizeValue(row["COD ARTICOL"]),
          DENUMIRE: normalizeValue(row["DENUMIRE ARTICOL"]),
          PM: normalizeValue(row["PM"]),
          VALOARE: parseFloat(row["VALOARE FACTURATA"] || 0),
          CANTITATE: parseFloat(row["CANTITATE FACTURATA"] || 0),
          CLIENTI: parseFloat(row["NR CLIENTI"] || 0)
        }));
      }

      if (productsData.length && salesData.length) {
        mergeDatasets();
      }
    };
    reader.readAsArrayBuffer(file);
  }

  // ===================== MERGE DATASETS =====================
  function mergeDatasets() {
    // Arată Matrix Rain pentru procesare
    showProcessingMatrix(0, "Inițializare sistem...");

    let temp = {};
    let idx = 0;
    let batchSize = 10000;

    function processBatch() {
      const end = Math.min(idx + batchSize, salesData.length);
      for (; idx < end; idx++) {
        const s = salesData[idx];
        if (!temp[s.COD]) {
          temp[s.COD] = {
            COD: s.COD,
            DENUMIRE: s.DENUMIRE,
            PM: s.PM,
            VALOARE: 0,
            CANTITATE: 0,
            CLIENTI: 0,
            AN: s.AN
          };
        }
        temp[s.COD].VALOARE += s.VALOARE;
        temp[s.COD].CANTITATE += s.CANTITATE;
        temp[s.COD].CLIENTI += s.CLIENTI;
      }

      const progress = Math.floor((idx / salesData.length) * 90);
      showProcessingMatrix(progress, `Procesare date: ${idx} / ${salesData.length} înregistrări`);

      if (idx < salesData.length) {
        setTimeout(processBatch, 0);
      } else {
        showProcessingMatrix(95, "Finalizare calcule...");
        
        mergedData = Object.values(temp).map(item => {
          const p = productsMap[item.COD] || {};
          const pretVanzare = p.PRET_VANZARE !== "nu e disponibil" && p.PRET_VANZARE ? parseFloat(p.PRET_VANZARE) : item.CANTITATE > 0 ? (item.VALOARE / item.CANTITATE) : 0;
          const cost = p.COST !== "nu e disponibil" && p.COST ? parseFloat(p.COST) : 0;
          const profitBrut = (pretVanzare > 0 && cost > 0) ? ((pretVanzare - cost) / pretVanzare * 100).toFixed(2) : "nu e disponibil";
          return {
            ...item,
            PRET_VANZARE: pretVanzare > 0 ? pretVanzare.toFixed(2) : "nu e disponibil",
            URL: p.URL || "nu e disponibil",
            COST: cost > 0 ? cost.toFixed(2) : "nu e disponibil",
            FURNIZOR_EXT: p.FURNIZOR_EXT || "nu e disponibil",
            PROFIT_BRUT: profitBrut
          };
        });

        showProcessingMatrix(100, "Procesare completă!");
        populateFilters();
        renderTopTable();
      }
    }

    processBatch();
  }

  // ===================== FILTRE & SEARCH =====================
  function populateFilters() {
    const yearSelect = document.getElementById("filterYear");
    const pmSelect = document.getElementById("filterPM");

    const years = [...new Set(salesData.map(s => s.AN))];
    yearSelect.innerHTML = '<option value="all">Toate</option>';
    years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);

    const pms = [...new Set(productsData.map(p => p.PM))];
    pmSelect.innerHTML = '<option value="all">Toate</option>';
    pms.forEach(pm => pmSelect.innerHTML += `<option value="${pm}">${pm}</option>`);
  }

  document.getElementById("filterYear").addEventListener("change", () => { currentPage = 1; renderTopTable(); });
  document.getElementById("filterPM").addEventListener("change", () => { currentPage = 1; renderTopTable(); });
  document.getElementById("topCriteria").addEventListener("change", () => { currentPage = 1; renderTopTable(); });
  document.getElementById("searchInput").addEventListener("input", () => { currentPage = 1; renderTopTable(); });

  // ===================== TABEL CU PAGINARE =====================
  function renderTopTable() {
    const yearFilter = document.getElementById("filterYear").value;
    const pmFilter = document.getElementById("filterPM").value;
    const criteria = document.getElementById("topCriteria").value;

    let data = getFilteredData();
    const totalPages = Math.ceil(data.length / rowsPerPage);
    const start = (currentPage - 1) * rowsPerPage;
    const pagedData = data.slice(start, start + rowsPerPage);

    const tbody = document.getElementById("topTableBody");
    tbody.innerHTML = pagedData.map((d, idx) => `
      <tr class="border-b hover:bg-gray-50 text-xs">
        <td class="px-2 py-3 w-16">${start + idx + 1}</td>
        <td class="px-2 py-3 w-24">${d.COD}</td>
        <td class="px-2 py-3 w-48">${d.DENUMIRE}</td>
        <td class="px-2 py-3 w-24">${d.PM}</td>
        <td class="px-2 py-3 w-32 font-semibold">${d.VALOARE.toFixed(0)}</td>
        <td class="px-2 py-3 w-24">${d.CANTITATE.toFixed(0)}</td>
        <td class="px-2 py-3 w-24">${d.CLIENTI}</td>
        <td class="px-2 py-3 w-32">${d.PRET_VANZARE}</td>
        <td class="px-2 py-3 w-32">${d.COST}</td>
        <td class="px-2 py-3 w-32">${d.PROFIT_BRUT}%</td>
        <td class="px-2 py-3 w-32">${d.FURNIZOR_EXT}</td>
        <td class="px-2 py-3 w-48">
          ${d.URL && d.URL !== "nu e disponibil"
            ? `<a href="${d.URL}" target="_blank">
                 <img data-url="${d.URL}" class="w-64 h-64 object-contain rounded-lg shadow border">
               </a>`
            : "nu e disponibil"}
        </td>
      </tr>`).join("");

    const images = document.querySelectorAll('#topTableBody img');
    Promise.all(Array.from(images).map(img => loadImage(img).then(() => new Promise(res => img.onload = res))));

    const pagination = document.getElementById("pagination");
    pagination.innerHTML = `
      <div class="flex justify-between items-center text-xs mt-2">
        <button ${currentPage === 1 ? "disabled" : ""} 
          onclick="prevPage()" 
          class="px-2 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50">Prev</button>
        <span class="font-medium">Pagina ${currentPage} din ${totalPages}</span>
        <button ${currentPage === totalPages ? "disabled" : ""} 
          onclick="nextPage(${totalPages})" 
          class="px-2 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50">Next</button>
      </div>`;

    renderChart(data);
  }

  function nextPage(total) {
    if (currentPage < total) { currentPage++; renderTopTable(); }
  }
  function prevPage() {
    if (currentPage > 1) { currentPage--; renderTopTable(); }
  }

  // ===================== CHART (Pie + Bar) =====================
  function renderChart(data) {
    const pmFilter = document.getElementById("filterPM").value;

    if (pmChart) pmChart.destroy();
    const ctx = document.getElementById("pmChart").getContext("2d");

    if (pmFilter === "all") {
      const pmGroups = {};
      data.forEach(d => { pmGroups[d.PM] = (pmGroups[d.PM] || 0) + d.VALOARE; });
      pmChart = new Chart(ctx, {
        type: "pie",
        data: { labels: Object.keys(pmGroups), datasets: [{ data: Object.values(pmGroups) }] },
        options: { responsive: true, plugins: { legend: { position: "right" } } }
      });
    } else {
      const topData = [...data].filter(d => d.PM === pmFilter).sort((a, b) => b.VALOARE - a.VALOARE).slice(0, 100);
      pmChart = new Chart(ctx, {
        type: "bar",
        data: { labels: topData.map(d => d.COD), datasets: [{ label: "Valoare Facturată", data: topData.map(d => d.VALOARE), backgroundColor: "#2563eb" }] },
        options: { responsive: true, indexAxis: "y", plugins: { legend: { display: false } }, scales: { x: { ticks: { precision: 0 } } } }
      });
    }
  }
</script>

</body>
</html>
